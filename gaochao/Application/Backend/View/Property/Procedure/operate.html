<extend name="Public/body" />
<block name="body">
    <div class="box box-body">
        <form action="" method="post" class="js_form">
            <input type="hidden" name="ids" value="<?=$info['id']?>" />
            <input type="hidden" name="buildings" id="building_ids" value="<?=$info['building_no']?>" />
            <input type="hidden" name="rooms" id="room_ids" value="<?=$info['room_no']?>" />
            <?php
                if(!$info['district_id']){
            ?>
            <div class="form-group">
                <div class="control-label">
                    <span class="required">*</span>
                    选择小区
                </div>
                <div>
                <select name="district_id" class="form-control input-md super_select2 width_auto" data-placeholder="请选择小区">
                    <option value="">请选择小区</option>
                    <?=$district?>
                </select>
                </div>
            </div>
            <?php }else{?>
            <div class="form-group">
                <div class="control-label">
                    <h5><?=$info['district_title']?></h5>
                </div>
            </div>
            <?php
                }
            ?>
            <div class="form-group">
                <div class="control-label">
                    <span class="required">*</span>
                    小区楼栋
                </div>
                <div>
                    <span class="select2 select2-container select2-container--default select2-container--below" dir="ltr" style="width: 300px;">
                        <span class="selection">
                               <span class="select2-selection select2-selection--multiple" role="combobox" aria-haspopup="true" aria-expanded="false" tabindex="-1">
                                    <ul class="select2-selection__rendered" id="building_ul">
                                        <!-- <span class="select2-selection__clear">×</span> -->
                                        <li class="select2-search select2-search--inline" value="text"><input class="select2-search__field" id="building_id"  type="search" tabindex="0" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" role="textbox" aria-autocomplete="list" placeholder="" style="width: 2.75em;"></li>
                                    </ul>
                                </span>
                        </span>
                        <span class="dropdown-wrapper" aria-hidden="true"></span>
                    </span>
                </div>
            </div>
            <div class="form-group">
                <div class="control-label">
                    <span class="required">*</span>
                    小区房号
                </div>
                <div>
                    <span class="select2 select2-container select2-container--default select2-container--below" dir="ltr" style="width: 300px;">
                        <span class="selection">
                               <span class="select2-selection select2-selection--multiple" role="combobox" aria-haspopup="true" aria-expanded="false" tabindex="-1">
                                    <ul class="select2-selection__rendered" id="room_ul">
                                        <!-- <span class="select2-selection__clear">×</span>    -->
                                        <li class="select2-search select2-search--inline" value="text"><input class="select2-search__field" id="room_id"  type="search" tabindex="0" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" role="textbox" aria-autocomplete="list" placeholder="" style="width: 2.75em;"></li>
                                    </ul>
                                </span>
                        </span>
                        <span class="dropdown-wrapper" aria-hidden="true"></span>
                    </span>
                </div>

            </div>
            <div class="form-group">
                <div class="control-label">
                    <span class="required">*</span>
                    议事名称
                </div>
                <div>
                    <input type="text" class="form-control width_auto" name="title" value="<?=$info['title']?>" datatype="*1-20" nullmsg="请输入名称" errormsg="请输入名称" />
                    <span class="Validform_checktip">1-20个字符</span>
                </div>
            </div>
            <div class="form-group">
                <div class="control-label">
                    <span class="required">*</span>
                    描述
                </div>
                <div>
                    <textarea class="form-control"  name="description" datatype="*1-200" errormsg="请输入描述"><?=$info['description']?></textarea>
                    <span class="Validform_checktip">1~255字符以内</span>
                </div>
            </div>
            <div class="form-group">
                <div class="control-label">
                    <span class="required">*</span>
                    图片
                </div>
                <div>
                    <?php
                        $config = array(
                            'index'     => 1,                   // 在当前页面中，调用的第几个文件上传插件，默认为1
                            'table'     => 'procedure_image',     // 数据保存在哪张表，此项必填
                            'table_id'  => 'pid',                // 数据所在表的主键，默认为id
                            'name'      => 'image',             // 此配置项主要用于设置表单提交时的name，非特殊情况下可以和val_key的配置值保持一致
                            'multi'     => 'true',             // 是否允许多文件上传，允许为true（前后需要添加引号），不允许为false（默认）
                            'val_key'   => 'image'              // 存储在数据表中的字段
                        );
                        echo W('Common/Img/index', array($config, $info['id']));
                    ?>
                    <span class="Validform_checktip">注意图片尺寸：</span>
                </div>
            </div>

            <div class="form-group">
                <div class="control-label"><span class="required">*</span>投票截止时间</div>
                <div class="form-inline">
                <input id="d4312" class="form-control input-sm wdate" type="text" name="end_date" onclick="WdatePicker({})" value="<?=$info['end_date']?>" />
                </div>
            </div>

            <div class="form-group">
                <div class="control-label">
                    排序
                </div>
                <div>
                    <input type="text" class="form-control width_auto" name="sort" value="<?=$info['sort']?>" />
                    <span class="Validform_checktip">可空，正整数</span>
                </div>
            </div>          
            
            <div class="form-btn clearfix">
                <input type="submit" class="pull-left btn btn-primary" value="提交" />
                <a href="<?=U('index')?>" class="pull-left btn btn-default">取消并返回</a>
                <div class="js_validTips pull-left" style="height:34px;line-height:34px;">
                    <span class="js_tipContent Validform_checktip"></span>
                </div>
            </div>
        </form>
    </div>
    <js href="__PLUGIN__/select2/select2.full.js" />
    <js href="__PLUGIN__/select2/super_select2.js" />
    <script type="text/javascript">
        $(function(){
            $('.super_select2').super_select2();
        });
    </script>  
    <script type="text/javascript">
        var array1 = new Array();
        var array2 = new Array();
        var i = 0;
        var j = 0;
        $(function(){

            var building_ids = $("#building_ids").val();
            var room_ids = $("#room_ids").val();
            if(building_ids.split(',')[0] != null && building_ids.split(',')[0] != ''){
                array2 = building_ids.split(',');
            }

            if(room_ids.split(',')[0] != null && room_ids.split(',')[0] != ''){
                array1 = room_ids.split(',');
            }
            // array2 = building_ids.split(',');
            // array1 = room_ids.split(',');

            if(array2.length > 0){
                array2.forEach(function(e){  
                    $("#building_ul").append(" <li id="+ e +" class='select2-selection__choice' value="+ e +" title='融城'><span class='select2-selection__choice__remove'  role='presentation'></span> "+ e + "</li>");
                });
            }
            if(array1.length > 0){
                array1.forEach(function(e){  
                     $("#room_ul").append(" <li id="+ e +" class='select2-selection__choice' value="+ e +" title='融城'><span class='select2-selection__choice__remove' role='presentation'></span> "+ e + "</li>");
                });
            }

            i = i + array1.length;
            j = j + array2.length; 

            //----------------------------------//

            function removeByValue(arr, val) {  
              for(var i=0; i<arr.length; i++) {  
                if(arr[i] == val) {  
                  arr.splice(i, 1);  
                  break;  
                }  
              }  
            }


            //---------------------------------//


            //---------------------------------//

            $("#building_id").keydown(function (e) {
              var curKey = e.which;
              if (curKey == 13) {
                if(j <= 9){
                    $("#building_ul").append(" <li id="+ $("#building_id").val() +" class='select2-selection__choice' value="+ $("#building_id").val() +" title='融城'><span class='select2-selection__choice__remove'  role='presentation'></span> "+ $("#building_id").val() + "</li>");
                     array2[j] = $("#building_id").val();
                    // $("room_ids").value(array);
                    j = j + 1;
                }
                $("#building_ids").val(array2);


            //     $("#building_ul li").on("click",function(){   //核心代码
            //     　　var a=$(this).attr("value");    //获取每个li的value值
            //         if(a != "text"){
            //            $("#"+a).remove();
            //            removeByValue(array2, a);
            //            $("#building_ids").val(array2);
            //         }
            // 　　});
              }
            });

            $("#room_id").keydown(function (e) {
              var curKey = e.which;
              if (curKey == 13) {
                if(i <= 9){
                    $("#room_ul").append(" <li id="+ $("#room_id").val() +" class='select2-selection__choice' value="+ $("#room_id").val() +" title='融城'><span class='select2-selection__choice__remove' role='presentation'></span> "+ $("#room_id").val() + "</li>");
                    array1[i] = $("#room_id").val();
                    // $("room_ids").value(array);
                    i = i + 1;
                }
                $("#room_ids").val(array1);

            //     $("#room_ul li").on("click",function(){   //核心代码
            //     　　var a=$(this).attr("value");    //获取每个li的value值
            //         if(a != "text"){
            //            $("#"+a).remove();
            //            removeByValue(array1, a);
            //            $("#room_ids").val(array1);
            //         }
            // 　　});

              }
            });
        });
    </script>
</block>